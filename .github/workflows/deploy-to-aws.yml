name: Deploy RAG to AWS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run tests
      run: |
        python -m pytest test_api.py -v || echo "Tests completed"
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Deploy to EC2
      run: |
        echo "=== Creating deployment package ==="
        tar -czf rag-deployment.tar.gz \
          --exclude='src/__pycache__' \
          --exclude='*.pyc' \
          src/ \
          requirements.txt \
          README.md \
          nginx-configs/ \
          docker-compose.yml \
          AttentionAllYouNeed.pdf
        
        echo "=== Uploading to EC2 ==="
        # Create SSH key from secret
        echo "${{ secrets.EC2_SSH_KEY }}" > /tmp/rag.pem
        chmod 600 /tmp/rag.pem
        
        # Debug key format
        echo "Key file size: $(wc -c < /tmp/rag.pem)"
        echo "Key file first line: $(head -1 /tmp/rag.pem)"
        
        # Upload and deploy
        scp -i /tmp/rag.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          rag-deployment.tar.gz ec2-user@${{ secrets.EC2_HOST }}:/tmp/
        
        ssh -i /tmp/rag.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          ec2-user@${{ secrets.EC2_HOST }} << 'EOSSH'
        
        echo "=== Deploying new version ==="
        cd /opt/rag-app
        
        # Backup current version
        sudo cp -r src src_backup_$(date +%Y%m%d_%H%M%S)
        
        # Extract new version
        tar -xzf /tmp/rag-deployment.tar.gz
        
        # Update environment
        source rag_env_38/bin/activate
        pip install -r requirements.txt --upgrade
        
        # Install Docker if not present
        if ! command -v docker &> /dev/null; then
          sudo yum update -y
          sudo yum install -y docker
          sudo systemctl start docker
          sudo systemctl enable docker
          sudo usermod -a -G docker ec2-user
        fi
        
        # Install Docker Compose if not present
        if ! command -v docker-compose &> /dev/null; then
          sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
        fi
        
        # Start Weaviate
        sudo docker-compose up -d || echo "Weaviate start failed, using mock store"
        
        # Clear any cached vector store data to force re-initialization
        echo "=== Clearing vector store cache ==="
        rm -rf /tmp/mock_vector_store.pkl || echo "No mock store to clear"
        
        # Clear Weaviate database by forcing document reload
        echo "=== Forcing document reload with new chunk settings ==="
        cd /opt/rag-app
        source rag_env_38/bin/activate
        python3 -c "
import sys
sys.path.append('src')
from src.rag_pipeline import RAGPipeline
import os

print('Initializing RAG pipeline...')
rag = RAGPipeline(prefer_weaviate=True)
if rag.initialize():
    print('Force reloading document with new chunk settings...')
    pdf_path = 'AttentionAllYouNeed.pdf'
    if os.path.exists(pdf_path):
        success = rag.load_document(pdf_path, clear_existing=True)
        if success:
            print('‚úÖ Document reloaded with new 24-chunk configuration')
        else:
            print('‚ùå Failed to reload document')
    else:
        print('‚ùå PDF file not found')
    rag.close()
else:
    print('‚ùå Failed to initialize pipeline')
" || echo "Document reload failed, continuing with deployment"
        
        # Stop and restart service to force pipeline re-initialization
        echo "=== Restarting service ==="
        sudo systemctl stop rag-app || echo "Service not running"
        sleep 3
        sudo systemctl start rag-app
        sleep 5
        sudo systemctl status rag-app --no-pager
        
        # Test deployment
        sleep 5
        curl -k https://localhost/health || echo "Health check failed"
        
        echo "‚úÖ Deployment completed"
        EOSSH
        
        # Cleanup
        rm /tmp/rag.pem
        
    - name: Notify deployment status
      run: |
        echo "üöÄ RAG system deployed to AWS EC2"
        echo "üì° URL: https://${{ secrets.EC2_HOST }}"
        echo "üîë Use bearer token for authentication"
