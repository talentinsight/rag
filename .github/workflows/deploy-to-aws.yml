name: Deploy RAG to AWS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run tests
      run: |
        python -m pytest test_api.py -v || echo "Tests completed"
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Deploy to EC2
      run: |
        echo "=== Creating deployment package ==="
        tar -czf rag-deployment.tar.gz \
          --exclude='src/__pycache__' \
          --exclude='*.pyc' \
          src/ \
          requirements.txt \
          README.md \
          nginx-configs/ \
          docker-compose.yml \
          AttentionAllYouNeed.pdf
        
        echo "=== Uploading to EC2 ==="
        # Create SSH key from secret
        echo "${{ secrets.EC2_SSH_KEY }}" > /tmp/rag.pem
        chmod 600 /tmp/rag.pem
        
        # Debug key format
        echo "Key file size: $(wc -c < /tmp/rag.pem)"
        echo "Key file first line: $(head -1 /tmp/rag.pem)"
        
        # Upload and deploy
        scp -i /tmp/rag.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          rag-deployment.tar.gz ec2-user@${{ secrets.EC2_HOST }}:/tmp/
        
        ssh -i /tmp/rag.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          ec2-user@${{ secrets.EC2_HOST }} << 'EOSSH'
        
        echo "=== Deploying new version ==="
        cd /opt/rag-app
        
        # Backup current version
        sudo cp -r src src_backup_$(date +%Y%m%d_%H%M%S)
        
        # Extract new version
        tar -xzf /tmp/rag-deployment.tar.gz
        
        # Update environment
        source rag_env_38/bin/activate
        pip install -r requirements.txt --upgrade
        
        # Install Docker if not present
        if ! command -v docker &> /dev/null; then
          sudo yum update -y
          sudo yum install -y docker
          sudo systemctl start docker
          sudo systemctl enable docker
          sudo usermod -a -G docker ec2-user
        fi
        
        # Install Docker Compose if not present
        if ! command -v docker-compose &> /dev/null; then
          sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
        fi
        
        # Start Weaviate
        sudo docker-compose up -d || echo "Weaviate start failed, using mock store"
        
        # Clear any cached vector store data to force re-initialization
        echo "=== Clearing vector store cache ==="
        rm -rf /tmp/mock_vector_store.pkl || echo "No mock store to clear"
        
        # Clear Weaviate database by forcing document reload
        echo "=== Forcing document reload with new chunk settings ==="
        cd /opt/rag-app
        source rag_env_38/bin/activate
        python3 -c 'import sys; sys.path.append("src"); from src.rag_pipeline import RAGPipeline; import os; rag = RAGPipeline(prefer_weaviate=True); rag.initialize() and os.path.exists("AttentionAllYouNeed.pdf") and rag.load_document("AttentionAllYouNeed.pdf", clear_existing=True) and rag.close()' || echo "Reload failed"
        
        # Stop and restart service to force pipeline re-initialization
        echo "=== Force killing all API processes ==="
        sudo pkill -f "uvicorn.*api" || echo "No uvicorn processes"
        sudo pkill -f "python.*api" || echo "No python API processes"
        
        echo "=== Clearing all caches ==="
        rm -rf /tmp/*.pkl || echo "No pkl files"
        rm -rf ~/.cache/ || echo "No cache dir"
        
        echo "=== Creating/Updating systemd services with environment variables ==="
        
        # Main RAG API service
        sudo tee /etc/systemd/system/rag-app.service > /dev/null << EOF
        [Unit]
        Description=RAG API Service
        After=network.target

        [Service]
        Type=simple
        User=ec2-user
        WorkingDirectory=/opt/rag-app
        Environment=PATH=/opt/rag-app/rag_env/bin:/opt/rag-app/rag_env_38/bin:/usr/bin:/bin
        Environment=PYTHONPATH=/opt/rag-app
        Environment=BEARER_TOKEN=${{ secrets.BEARER_TOKEN }}
        Environment=OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        Environment=PDF_PATH=/opt/rag-app/AttentionAllYouNeed.pdf
        Environment=WEAVIATE_URL=http://localhost:8080
        Environment=HOST=0.0.0.0
        Environment=PORT=8000
        Environment=ENVIRONMENT=production
        ExecStart=/opt/rag-app/rag_env_38/bin/uvicorn src.api_comprehensive_guardrails:app --host 0.0.0.0 --port 8000
        Restart=always
        RestartSec=10
        StandardOutput=journal
        StandardError=journal

        [Install]
        WantedBy=multi-user.target
        EOF
        
        # MCP WebSocket service
        sudo tee /etc/systemd/system/rag-mcp.service > /dev/null << EOF
        [Unit]
        Description=RAG MCP WebSocket Server
        After=network.target rag-app.service

        [Service]
        Type=simple
        User=ec2-user
        WorkingDirectory=/opt/rag-app
        Environment=PATH=/opt/rag-app/rag_env/bin:/opt/rag-app/rag_env_38/bin:/usr/bin:/bin
        Environment=PYTHONPATH=/opt/rag-app
        Environment=BEARER_TOKEN=${{ secrets.BEARER_TOKEN }}
        Environment=OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        Environment=PDF_PATH=/opt/rag-app/AttentionAllYouNeed.pdf
        Environment=WEAVIATE_URL=http://localhost:8080
        Environment=HOST=0.0.0.0
        Environment=PORT=8001
        Environment=ENVIRONMENT=production
        ExecStart=/opt/rag-app/rag_env_38/bin/python -m src.mcp_websocket_server
        Restart=always
        RestartSec=10
        StandardOutput=journal
        StandardError=journal

        [Install]
        WantedBy=multi-user.target
        EOF
        
        sudo systemctl daemon-reload
        sudo systemctl enable rag-app
        sudo systemctl enable rag-mcp

        echo "=== Fresh service restart ==="
        sudo systemctl stop rag-app || echo "RAG API service not running"
        sudo systemctl stop rag-mcp || echo "MCP service not running"
        sleep 5
        sudo systemctl start rag-app
        sudo systemctl start rag-mcp
        sleep 10
        sudo systemctl status rag-app --no-pager
        sudo systemctl status rag-mcp --no-pager
        
        # Test deployment
        sleep 5
        curl -k https://localhost/health || echo "Health check failed"
        
        echo "âœ… Deployment completed"
        EOSSH
        
        # Cleanup
        rm /tmp/rag.pem
        
    - name: Notify deployment status
      run: |
        echo "ðŸš€ RAG system deployed to AWS EC2"
        echo "ðŸ“¡ URL: https://${{ secrets.EC2_HOST }}"
        echo "ðŸ”‘ Use bearer token for authentication"
